"use strict";

$.ajaxSetup({
    headers: {
        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content'),
    }
});

socket.on('disconnect', () => {
	// console.log('user_id on disconnect', user_id)
	update_user_state( user_id, 0 );
});

socket.on('bs-new-user-connected', () => {
	// console.log('finally new-user-connected')
	get_online_users();
});

socket.on('user-disconnected', function() {
	// console.log('finally user is disconnected.')
  	get_online_users();
});

$(document).on('click', '#logout, #responsive-logout', function(event) {
	event.preventDefault();

	socket.disconnect();

	if ( socket.disconnected ) {
		let $this = $(this);
		setTimeout(() => {
			$this.closest('form').submit();
		}, 800)
	}
});

let get_online_users = () => {
	setTimeout(() => {
		$.ajax({
	  		url: GET_ONLINE_USERS,
	  		type: 'get',
	  		dataType: 'json',
	  		async: false,
	  		cache: false,
	  		complete: response => {
	  			let resp = response.responseJSON;
	  			if ( resp ) {
	  				if ( resp.status ) {
	  					$('#online-user-list').html(resp.data.view)
	  				}
	  			}
	  		},
	  		error: error => {},
	  	});
	}, 800)
}

let update_user_state = (user_id, availability_status) => {
	let response = false;
	$.ajax({
  		url: UPDATE_ONLINE_STATUS,
  		type: 'post',
  		dataType: 'json',
  		async: false,
  		cache: false,
  		data: {
  			user_id: user_id,
  			availability_status: availability_status,
  		},
  		complete: response => {
			response = true;
  		}
  	});

  	return response;
}